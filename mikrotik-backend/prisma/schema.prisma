generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int             @id @default(autoincrement())
  username       String          @unique
  password       String
  role           UserRole        @default(USER)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  logs           ActivityLog[]
  configs        Config[]
  managedDevices ManagedDevice[]
}

model DeviceModel {
  id       Int            @id @default(autoincrement())
  name     String         @unique
  imageUrl String?
  configs  Config[]
  ports    PortTemplate[]
}

model PortTemplate {
  id            Int         @id @default(autoincrement())
  name          String
  type          PortType    @default(ETHER)
  defaultRole   String?
  deviceModelId Int
  deviceModel   DeviceModel @relation(fields: [deviceModelId], references: [id], onDelete: Cascade)

  @@index([deviceModelId], map: "PortTemplate_deviceModelId_fkey")
}

model SystemSetting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String @db.Text
}

model Config {
  id              Int         @id @default(autoincrement())
  projectName     String
  inputData       String      @db.LongText
  generatedScript String      @db.LongText
  userId          Int
  deviceModelId   Int
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deviceModel     DeviceModel @relation(fields: [deviceModelId], references: [id])
  user            User        @relation(fields: [userId], references: [id])

  @@index([deviceModelId], map: "Config_deviceModelId_fkey")
  @@index([userId], map: "Config_userId_fkey")
}

model ActivityLog {
  id        Int        @id @default(autoincrement())
  userId    Int
  action    ActionType
  details   String?
  ipAddress String?
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id])

  @@index([userId], map: "ActivityLog_userId_fkey")
}

model ManagedDevice {
  id         Int       @id @default(autoincrement())
  name       String
  circuitId  String?
  apiToken   String    @unique @default(uuid())
  currentIp  String    @default("127.0.0.1")
  lastSeen   DateTime?
  pendingCmd String?
  configData Json?
  userId     Int
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id])

  @@index([userId], map: "ManagedDevice_userId_fkey")
}

enum UserRole {
  ADMIN
  USER
}

enum PortType {
  ETHER
  SFP
  SFP_PLUS
  QSFP
  WLAN
  LTE
}

enum ActionType {
  LOGIN
  GENERATE_CONFIG
  DOWNLOAD_CONFIG
  UPDATE_PROFILE
}
