generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int             @id @default(autoincrement())
  username       String          @unique
  password       String
  role           UserRole        @default(USER)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  logs           ActivityLog[]
  configs        Config[]
  managedDevices ManagedDevice[]
}

model DeviceModel {
  id       Int            @id @default(autoincrement())
  name     String         @unique
  imageUrl String?
  isActive  Boolean        @default(true)
  configs  Config[]
  ports    PortTemplate[]
}

model PortTemplate {
  id            Int         @id @default(autoincrement())
  name          String
  type          PortType    @default(ETHER)
  defaultRole   String?
  deviceModelId Int
  deviceModel   DeviceModel @relation(fields: [deviceModelId], references: [id], onDelete: Cascade)

  @@index([deviceModelId], map: "PortTemplate_deviceModelId_fkey")
}

model SystemSetting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String @db.Text
}

model Config {
  id              Int         @id @default(autoincrement())
  projectName     String
  inputData       Json
  generatedScript String      @db.Text
  
  // ✅ เชื่อมโยงกับ ManagedDevice (สำคัญสำหรับการเปลี่ยน Model)
  managedDeviceId Int?        
  managedDevice   ManagedDevice? @relation(fields: [managedDeviceId], references: [id])

  // ยังคงเก็บ Model ไว้ เพื่อให้รู้ว่าประวัตินี้ใช้กับรุ่นไหน
  deviceModelId   Int
  deviceModel     DeviceModel @relation(fields: [deviceModelId], references: [id])
  
  userId          Int
  user            User        @relation(fields: [userId], references: [id])
  createdAt       DateTime    @default(now())

  @@index([managedDeviceId])
  @@index([deviceModelId], map: "Config_deviceModelId_fkey")
  @@index([userId], map: "Config_userId_fkey")
}

model ActivityLog {
  id        Int        @id @default(autoincrement())
  userId    Int
  action    ActionType
  details   String?
  ipAddress String?
  createdAt DateTime   @default(now())
  user      User       @relation(fields: [userId], references: [id])

  @@index([userId], map: "ActivityLog_userId_fkey")
  @@index([createdAt]) 
  @@index([action])
}

model ManagedDevice {
  id          Int       @id @default(autoincrement())
  name        String
  circuitId   String?
  apiToken    String    @unique @default(uuid())
  currentIp   String    @default("127.0.0.1")
  lastSeen    DateTime?
  pendingCmd  String?
  configData  Json?
  
  // Monitoring Fields
  status      String    @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  cpuLoad     Int?      @default(0)
  memoryUsage Int?      @default(0)
  uptime      String?
  version     String?
  boardName   String?

  storage     Int?      @default(0)
  temp        String?
  latency     String?
  
  userId      Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])

  // Acknowledge System
  isAcknowledged Boolean   @default(false)
  ackReason      String?
  ackByUserId    Int?
  ackAt          DateTime?
  
  // Relation ไปยัง Config History
  configHistory Config[]

  @@index([userId], map: "ManagedDevice_userId_fkey")
}

enum UserRole {
  ADMIN
  USER
}

enum PortType {
  ETHER
  SFP
  WLAN
}

enum ActionType {
  LOGIN
  LOGOUT
  CREATE_DEVICE
  UPDATE_DEVICE
  DELETE_DEVICE
  GENERATE_CONFIG
}